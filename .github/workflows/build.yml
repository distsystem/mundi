name: Build all packages

permissions:
  id-token: write
  contents: read

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      package_name:
        description: "Specify a package name to build (skips change detection)"
        required: false
        type: string
  pull_request:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.detect-packages.outputs.has_changes }}
      build_matrix: ${{ steps.detect-packages.outputs.build_matrix }}
    env:
      PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request && github.event.pull_request.head.ref || github.ref_name }}

      - name: Setup Pulumi ESC
        uses: pulumi/esc-action@v1
        with:
          environment: distsystem-dev/distsystem-dev

      - name: Setup pixi
        uses: ./.github/pixi-setup

      - name: Detect changed packages
        id: detect-packages
        shell: bash
        run: |
          MATRIX=$(pixi run meta changes)
          echo "Matrix output: $MATRIX"

          if [ "$MATRIX" = "[]" ]; then
            echo "No packages changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "build_matrix=[]" >> $GITHUB_OUTPUT
          else
            echo "Changed packages detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "build_matrix=$MATRIX" >> $GITHUB_OUTPUT
          fi

      - name: Setup tmate session
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 15
        with:
          limit-access-to-actor: true

  no-changes:
    needs: detect-changes
    if: ${{ github.event_name != 'workflow_dispatch' && needs.detect-changes.outputs.has_changes == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: No changes detected
        run: echo "No package changes detected. Skipping build jobs."

  build-packages-dispatch:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.package_name != ''
    runs-on: ubuntu-latest
    outputs:
      has_artifact_packages: ${{ steps.check-artifact-packages.outputs.has_artifact_packages }}
      manual_package: ${{ github.event.inputs.package_name }}
    env:
      PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
    strategy:
      matrix:
        include:
          - package: ${{ github.event.inputs.package_name }}
      fail-fast: false

    name: Build ${{ matrix.package }} (manual)
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Pulumi ESC
        uses: pulumi/esc-action@v1
        with:
          environment: distsystem-dev/distsystem-dev

      - name: Build Package
        uses: ./.github/actions/build-package
        with:
          package: ${{ matrix.package }}
          upload_condition: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
          github_token: ${{ env.GITHUB_TOKEN }}
          s3_access_key_id: ${{ env.S3_ACCESS_KEY_ID }}
          s3_secret_access_key: ${{ env.S3_SECRET_ACCESS_KEY }}
          s3_endpoint_url: ${{ env.S3_ENDPOINT_URL }}

  build-packages:
    needs: [detect-changes]
    if: |
      github.event_name != 'workflow_dispatch' &&
      needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    outputs:
      has_artifact_packages: ${{ steps.check-artifact-packages.outputs.has_artifact_packages }}
    env:
      PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
    strategy:
      matrix:
        include: ${{ fromJson(needs.detect-changes.outputs.build_matrix) }}
      fail-fast: false

    name: Build ${{ matrix.package }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Pulumi ESC
        uses: pulumi/esc-action@v1
        with:
          environment: distsystem-dev/distsystem-dev

      - name: Build Package
        uses: ./.github/actions/build-package
        with:
          package: ${{ matrix.package }}
          upload_condition: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
          github_token: ${{ env.GITHUB_TOKEN }}
          s3_access_key_id: ${{ env.S3_ACCESS_KEY_ID }}
          s3_secret_access_key: ${{ env.S3_SECRET_ACCESS_KEY }}
          s3_endpoint_url: ${{ env.S3_ENDPOINT_URL }}

  update-index:
    needs: [build-packages, build-packages-dispatch]
    if: |
      always() &&
      (needs.build-packages.result == 'success' || needs.build-packages-dispatch.result == 'success')
    runs-on: ubuntu-latest
    env:
      PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pulumi ESC
        uses: pulumi/esc-action@v1
        with:
          environment: distsystem-dev/distsystem-dev

      - name: Setup pixi
        uses: ./.github/pixi-setup

      - name: Update package index
        shell: bash
        run: |
          echo "Updating package index after successful builds..."
          pixi run index
        env:
          GH_TOKEN: ${{ env.GITHUB_TOKEN }}
          S3_ACCESS_KEY_ID: ${{ env.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ env.S3_SECRET_ACCESS_KEY }}
          S3_ENDPOINT_URL: ${{ env.S3_ENDPOINT_URL }}
