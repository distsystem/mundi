name: Build packages

permissions:
  id-token: write
  contents: read

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      package_name:
        description: "Specify a package name to build (skips change detection)"
        required: false
        type: string
  pull_request:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.detect-packages.outputs.has_changes }}
      build_matrix: ${{ steps.detect-packages.outputs.build_matrix }}
    env:
      PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.ref_name }}

      - uses: pulumi/esc-action@v1
        with:
          environment: distsystem-dev/distsystem-dev

      - uses: actions/checkout@v4
        with:
          repository: distsystem/meta-forge
          path: ../meta-forge

      - uses: ./.github/pixi-setup

      - name: Detect changed packages
        id: detect-packages
        run: |
          if [[ -n "${{ github.event.inputs.package_name }}" ]]; then
            MATRIX='[{"package":"${{ github.event.inputs.package_name }}"}]'
          else
            MATRIX=$(pixi run meta changes)
          fi
          echo "Matrix output: $MATRIX"
          if [ "$MATRIX" = "[]" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "build_matrix=[]" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "build_matrix=$MATRIX" >> $GITHUB_OUTPUT
          fi

      - uses: mxschmitt/action-tmate@v3
        if: failure()
        timeout-minutes: 15
        with:
          limit-access-to-actor: true

  build-packages:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    env:
      PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
    strategy:
      matrix:
        include: ${{ fromJson(needs.detect-changes.outputs.build_matrix) }}
      fail-fast: false
    name: Build ${{ matrix.package }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: pulumi/esc-action@v1
        with:
          environment: distsystem-dev/distsystem-dev

      - uses: actions/checkout@v4
        with:
          repository: distsystem/meta-forge
          path: ../meta-forge

      - uses: ./.github/pixi-setup

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ccache
            ~/.cache/sccache
          key: ${{ runner.os }}-build-cache-${{ matrix.package }}-${{ hashFiles('**/recipe.yaml') }}
          restore-keys: |
            ${{ runner.os }}-build-cache-${{ matrix.package }}-

      - name: Build package
        run: |
          if [[ "${{ github.event_name }}" == "push" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            pixi run build-upload ${{ matrix.package }}
          else
            pixi run build ${{ matrix.package }}
          fi
